<template clients user>
<div class=two-columns>

  <async-block :loaded="${ this.loaded }" class="block">
    <h1><x-icon figure=address-book></x-icon>Overview</h1>

    <section class="search row">
      <input type=search name=q on:keyup="this.searchClient" placeholder="Search for a client by name">
    </section>

    <section class=filters>
      Filter by
      <x-tag on:click="this.filterTag" value="" :selected="this.tag == ''">All</x-tag>
      <x-tag :for="tagName in this.tags" on:click="this.filterTag" value="${ this.tagName }"  :selected="this.tagName == this.tag">${ this.tagName }</x-tag>
    </section>

    <nav :if="${ this.clients.length }">
      <h2 :if="${ !this.tag }">${ this.clients.length } clients</h2>
      <h2 :if="${ this.tag }">${ this.clients.length } clients in group "${ this.tag }"</h2>
      <a :for="client in this.clients" href="/client/${ this.client.id }">
        <h3><x-icon figure=user></x-icon>${ this.client.name }</h3>
        <p :if="this.client.assignments.length && this.client.assignments.slice(-1)[0].status === 'completed'"><x-icon figure=clock color=#F5BA01></x-icon>
          Completed on ${(new Date(this.client.assignments.reverse()[0].creation_date * 1000)).toLocaleDateString() } – ${ this.client.assignments.length } tests
        </p>
        <p :if="this.client.assignments.length && this.client.assignments.slice(-1)[0].status === 'pending'"><x-icon figure=clock color=#F5BA01></x-icon>
          Pending since ${(new Date(this.client.assignments.reverse()[0].creation_date * 1000)).toLocaleDateString() } – ${ this.client.assignments.length }
          <span :if="${this.client.assignments.length == 1}">test</span>
          <span :if="${this.client.assignments.length > 1}">tests</span>
        </p>
        <p :if="!this.client.assignments.length">
          No test yet
        </p>
        <div class=tags>
          <x-tag :for="tag in this.client.tags" on:click="this.filterTag" value="${ this.tag }">${ this.tag }</x-tag>
        </div>
      </a>
    </nav>
    <div :if="${ !this.clients.length && !this.tags.length }">
      <h2>Welcome to the TCI Site for Professionals!</h2>

      <p>Assigning tests and getting results is simple; just follow these steps:</p>
      <ol>
        <li><x-icon figure=credit-card></x-icon> Purchase credits.</li>
        <li><x-icon figure=user-plus></x-icon> Add a client or clients.</li>
        <li><x-icon figure=file-medical></x-icon> Assign the client a test.</li>
        <li>Wait to receive an automatically generated email notification that your client has finished the test, and then you can access the results in their profile.</li>
      </ol>
      <p>For more details, <a href=/help>visit the help section</a>.</p>
    </div>

    <footer class="row toolbar">
      <a href=/client class="button"><x-icon figure=user-plus></x-icon>Add a client</a>
    </footer>
  </async-block>

  <aside class=block>
    <h1><x-icon figure=balance-scale></x-icon>Balance</h1>
    <p><strong>${ this.user.credit }</strong> credits remaining</p>
    <p class=row>
      <span>Add</span>
      <input name=quantity type=number on:input="this.addCredit" value=150>
      <span>credits to my account.</span>
    </p>
    <stripe-button quantity="${ this.quantity || 150 }" class="button primary"><x-icon figure=credit-card></x-icon> Purchase</stripe-button>

    <details>
      <summary>About the Credit System</summary>

      <p>1 credit = $5 (or $4 when purchasing 150 credits or more)</p>

      <h4>Standard Analysis:</h4>
      <ul>
        <li>Includes 1D, 2D, and 3D analysis = 3 credits</li>
        <li>Automatically generated when you assign a test to a client</li>
      </ul>
      <h4>Additional Analyses:</h4>
      <p>You can add any of the following to the standard analysis at any stage:</p>
      <ul>
        <li>3D+ (Resilience Analysis) = 1 credit</li>
        <li>U/S (Unity and Separateness) = 1 credit</li>
        <li>V/P (Validity and Performance) = 1 credit<em> – Coming soon!</em></li>
      </ul>
    </details>
  </aside>

</div>
</template>

<script>
  this.setState({
    quantity: 0,
    clients: [],
    user: { credit: 0 },
    tags: [],
    tag: '',
    q: '',
    loaded: false,
  })
  this.searchTimeout = null

  this.connected = async () => {
    const tagsResponse = await api('/provider/tags')
    this.setState({ tags: tagsResponse.data }, false)
    this.updateClients()
    this.state.loaded = true
  }

  this.updateClients = async () => {
    const response = await api(`/clients?q=${ this.state.q }&tag=${ this.state.tag }`)
    if(!response.ok) return notify(response.data, 'error')
    this.render({ clients: response.data })
  }

  this.addCredit = (event) => {
    this.render({ quantity: event.currentTarget.value })
  }

  this.filterTag = (event) => {
    this.setState({ tag: event.target.getAttribute('value') }, false)
    this.updateClients()
  }

  this.searchClient = (event) => {
    if(this.searchTimeout) clearTimeout(this.searchTimeout)
    const q = event.target.value
    this.searchTimeout = setTimeout(() => {
      this.setState({ q }, false)
      this.updateClients()
    }, 400)
  }
</script>

<style>
  @import url('/assets/css/main.css');

  nav a {
    position: relative;
    display: block;
    padding: .3rem .5rem;
    text-decoration: none;
    color: inherit;
    border-bottom: 1px solid #eee;
    transition: all .2s;
  }
  nav a:last-of-type {
    border-bottom: none;
  }
  nav a:hover,
  nav a:focus {
    background-color: var(--light-color);
    color: white;
    padding-left: .8rem;
  }
  nav h3,
  nav p {
    padding: 0;
    margin: 0;
    font-size: inherit;
  }
  nav p {
    font-size: .7rem;
    opacity: .8;
  }
  nav x-icon {
    display: inline-block;
    width: 1rem;
  }
  nav .tags {
    position: absolute;
    right: 1rem;
    top: .5rem;
  }

  .filters {
    padding-bottom: 1rem;
    border-bottom: 1px solid #eee;
    margin-bottom: 1rem;
  }

  aside input {
    width: 3rem;
    min-width: inherit;
    padding: .1rem;
    border: 0;
    border-bottom: 1px dashed #888;
    text-align: center;
  }

  stripe-button {
    display: block !important;
    margin-top: 2rem;
  }

  aside details {
    margin-top: 2rem;
  }
</style>
