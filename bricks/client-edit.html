<template id>
<div class=two-columns>
  <main class=block>
    <h1><x-icon figure=user-edit></x-icon>
      <span :if="this.client.id">${ this.client.name }'s Profile</span>
      <span :if="!this.client.id">Add a New Client</span>
    </h1>
    <form on:submit="this.submit">

      <label>Full Name</label>
      <input name=name placeholder="Full Name*" value="${ this.client.name }" required>

      <label>Email</label>
      <input type=email name=email placeholder="Email" value="${ this.client.email }">

      <label>Gender</label>
      <select name=gender required>
        <option value="m" :selected="${ this.client.gender == 'm' }">Male</option>
        <option value="f" :selected="${ this.client.gender == 'f' }">Female</option>
        <option value="tm" :selected="${ this.client.gender == 'tm' }">Trans-Male</option>
        <option value="tf" :selected="${ this.client.gender == 'tf' }">Trans-Female</option>
        <option value="to" :selected="${ this.client.gender == 'to' }">Genderqueer/Non-binary</option>
        <option value="o" :selected="${ this.client.gender == 'o' }">Not listed/Other</option>
        <option value="u" :selected="${ this.client.gender == 'u' }">Prefer not to say</option>
      </select>
      <small>Select the option that best describes your current gender identity.</small>

      <div>
        <label>Year of birth</label>
        <input type=number name=birthyear value="${ this.client.birthyear || '1970' }" min="${ this.year - 100 }" max="${ this.year }" required>
      </div>

      <fieldset>
        <legend>Test Information</legend>
        <div>
          <label>Test Language</label>
          <div>
            <select name=language>
              <option value=en :selected="${ this.client.language == 'en' }">English</option>
              <option value=fr :selected="${ this.client.language == 'fr' }">French</option>
              <option value=se :selected="${ this.client.language == 'se' }">Swedish</option>
            </select>
          </div>
        </div>
        <div>
          <label>Test Country</label>
          <div>
            <select name=culture>
              <option value=fr :selected="${ this.client.culture == 'fr' }">France</option>
              <option value=se :selected="${ this.client.culture == 'se' }">Sweden</option>
              <option value=us :selected="${ this.client.culture == 'us' }">United States</option>
            </select>
            <small>This field determines which norms are used to analyze the test results.</small>
          </div>
        </div>
      </fieldset>

      <fieldset>
        <legend>Personal Notes</legend>

        <label>Groups (comma separated)</label>
        <div>
          <input name=tags placeholder="Assigned groups (insert multiple tags, separate with a comma)" value="${ this.client.tags.join(', ') }" list=tags-list>
          <small if="${this.client.tags.length }">Your existing goups: ${ this.client.tags.join(', ') }</small>
        </div>
        <label>Notes</label>
        <textarea name=note placeholder="Extra information about the client or the sessions">${ this.client.note || '' }</textarea>
      </fieldset>

      <footer class=toolbar>
        <button class=primary>Save</button>
        <a href=/ class=button>Cancel</a>
        <div class="secondary">
          <button type=button :if="this.client.id" on:click="this.delete" class="danger">Delete</delete>
        </div>
      </footer>
    </form>
  </main>

  <aside class="block" :if="this.client.id">
    <h1><x-icon figure=file-medical-alt></x-icon>Assigned Testser</h1>
    <ul>
      <li :for="assignment in this.assignments">
        <div :if="this.assignment && this.assignment.status === 'pending'">
          <span><x-icon figure=clock color=#F5BA01></x-icon>pending since ${ date(this.assignment.creation_date) }</span>
          <nav class=actions>
            <a href="${ this.assignment.url }" title="Go to the test" target=_blank>
              <x-icon figure=file-signature></x-icon>
            </a>
            <a :if="this.client.email" on:click="this.sendMail" href="#" title="Send the test to the client via email" id="${ this.assignment.id }">
              <x-icon figure=envelope></x-icon>
            </a>
            <x-icon figure=trash on:click="this.removeAssignement" value="${ this.assignment.id }" title="Unassign this test from the client"></x-icon>
          </nav>
        </div>
        <div :if="this.assignment && this.assignment.status === 'completed'">
          <span><x-icon figure=file-invoice></x-icon>completed on ${ date(this.assignment.completion_date) }</span>
          <nav class=actions>
            <a class=score href="${config.api_url}/${ this.client.language }/${ this.assignment.id }/score/1d.pdf" target=_blank title="Download results in 1D">1D</a>
            <a class=score href="${config.api_url}/${ this.client.language }/assignment/${ this.assignment.id }/score/2d.html" target=_blank title="Download results in 2D">2D</a>
            <a class=score href="${config.api_url}/${ this.client.language }/assignment/${ this.assignment.id }/score/3d.pdf" target=_blank title="Download results in 3D">3D</a>
            <hr>
            <a class=score on:click="this.scoreOrPurchase" :disabled="${ !this.assignment.options.includes('3d-plus') }" version="3d-plus" assignmentid="${ this.assignment.id }" href="${config.api_url}/${ this.client.language }/assignment/${ this.assignment.id }/score/3d-plus.pdf" target=_blank title="Download results in 3D+">3D+</a>
            <a class=score on:click="this.scoreOrPurchase" :disabled="${ !this.assignment.options.includes('unity-separateness') }" version="unity-separateness" assignmentid="${ this.assignment.id }" href="${config.api_url}/${ this.client.language }/${ this.assignment.id }/score/unity-separateness.pdf" target=_blank title="Download results for Unity and Separateness">U/S</a>
          </nav>
          <div :if="{ this.assignmentId == this.assignment.id }" class="purchase row">
            <button class=primary on:click="this.purchase">Purchase this ${ this.assignmentVersion } score</button>
            <button on:click="this.cancelPurchase">Cancel</button>
          </div>
        </div>
      </li>
    </ul>
    <button class=primary on:click="this.assign"><x-icon figure=file-medical></x-icon>Assign a New Test</button>
    <p :if="${ user.credit < 3 }">You need at least 3 credits to assign a new test. <a href=/>Purchase credits</a></p>
  </aside>

</div>
</template>

<script>
  const defaults = {
    id: null,
    client: { tags: [], assignments: [] },
    assignments: [],
    assignmentVersion: '',
    purchaseId: null,
    year: (new Date()).getFullYear(),
  }
  this.setState(defaults)

  function assignmentsFromResponse (assignments) {
    return assignments.reverse().map(assignment => {
      assignment.url = config.tests_url.replace('{key}', assignment.key)
      return assignment
    })
  }

  this.connected = async () => {
    if(this.state.id) {
      const response = await api(`/client/${this.state.id}`)
      if(response.data) {
        this.state.client = response.data
        this.state.assignments = assignmentsFromResponse(this.state.client.assignments)
      }
    }
    this.render()
  }

  this.scoreOrPurchase = (event) => {
    const button = event.target
    if(!button.hasAttribute('disabled')) return
    event.preventDefault()
    this.render({ assignmentVersion: button.getAttribute('version'), assignmentId: button.getAttribute('assignmentid') })
  }

  this.purchase = async () => {
    const response = await api(`/assignment/${this.state.assignmentId}/purchase`,
    { data: { version: this.state.assignmentVersion }} )
    if(response.ok) {
      const index = this.state.assignments.findIndex(a => a.id == this.state.assignmentId)
      this.state.assignments[index] = response.data
      this.render({ assignmentId: '', assignmentVersion: '' })
      notify(`Your ${this.state.assignmentVersion} sheet is ready`, 'info')
    }
    else notify(response.data, 'error')
  }

  this.cancelPurchase = () => {
    this.render({ assignmentId: null, assignmentVersion: '' })
  }

  this.assign = async () => {
    const response = await api(`/client/${this.state.id}/assignment`, { method: 'post' })
    if (response.data) {
      this.render({ assignments: assignmentsFromResponse(response.data.assignments) })
      notify('A new assignment is available for this client', 'success')
    }
  }

  this.sendMail = (event) => {
    const link = event.currentTarget
    const assignment = this.state.assignments.find(a => a.id === link.id)
    const body = `Here is a link for you to access the TCI: ${assignment.url}

Read the instructions carefully, and please be sure to take it in one sitting as your responses will not be saved if you close your browser. In the event you need to exit the browser before you are finished, you will need to start from the beginning the next time.

Also, note that once you make a selection for an item, you will automatically be brought to the next question, with no option of changing your first response or going back to previous items.

Let me know if you have any questions.

Enjoy!`
    link.href = `
    mailto:${ this.state.client.email }?subject=A TCI has been assigned to you&body=${ encodeURIComponent(body.trim()) }`
  }

  // pass component scope to function
  const component = this
  this.removeAssignement = async function (event) {
    if(!confirm('Are your sure you want to remove this assignment?')) return
    const response = await api(`/assignment/${this.getAttribute('value')}`, { method: 'delete' })
    component.render({ assignments: response.data.assignments.reverse() })
  }

  this.submit = async (event) => {
    event.preventDefault()
    const client = this.state.client
    const form = event.currentTarget
    const data = {}
    Array.from(form.elements).filter(e => e.name && e.value).forEach(e => data[e.name] = e.value)
    data.tags = data.tags && data.tags.split(',')
    const response = client.id
                   ? await api(`/client/${client.id}`, { data, method: 'PUT' })
                   : await api(`/client`, { data })
    if(!response.ok) {
      if(response.data.includes('duplicate key error')) return notify("A client exists with similar data. Is it a duplicate?", 'warning')
      return notify('An error occured and the client could not be saved!', 'error')
    }
    page('/')
  }

  this.delete = async () => {
    if(!confirm("Are you sure you want to delete this client and all his data?")) return
    const response = await api(`/client/${ this.state.client.id }`, { method: 'delete' })
    if(!response.ok) return notify("An error occured. This contact could not be deleted!", 'error')
    page('/')
  }
</script>

<style>
  @import url('/assets/css/main.css');

  aside ul {
    padding: 0;
    list-style: none;
  }

  aside li {
    display: flex;
    justify-content: space-between;
    padding: .5rem 0;
    border-bottom: 1px solid #eee;
  }
  nav {
    display: flex;
  }
  nav > a,
  nav > x-icon {
    display: block;
    font-size: .7rem;
    font-weight: bold;
    color: var(--primary-color);
    cursor: pointer;
    text-decoration: none;
    text-align: center;
    padding: .2rem;
    border-radius: .2rem;
    border: 1px solid transparent;
  }
  nav > a:hover,
  nav > x-icon:hover {
    border-color: var(--primary-color);
  }
  nav > hr {
    margin: .5rem;
  }

  aside button {
    width: 100%;
    margin-top: 1rem;
  }

  select {
    width: 100%;
  }

  a.score[disabled] {
    color: #999;
    font-weight: normal;
  }

  a.score[disabled]:hover {
    border: 1px dashed #999;
  }

  .purchase {
    margin: 0;
  }
</style>
