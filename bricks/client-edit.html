<template id>
<div class=two-columns>
  <main class=block>
    <h1><x-icon figure=user-edit></x-icon>
      <span :if="this.client.id">${ this.client.name }'s Profile</span>
      <span :if="!this.client.id">Add a New Client</span>
    </h1>
    <form on:submit="this.submit">

      <label>Full Name</label>
      <input name=name placeholder="Full Name*" value="${ this.client.name }" required>

      <label>Email</label>
      <input type=email name=email placeholder="Email" value="${ this.client.email }">

      <fieldset>
        <legend>Test Informations</legend>
        <div class=row>
          <label>Language for the test</label>
          <select name=language>
            <option value=fr :selected="${ this.client.language == 'fr' }">French</option>
            <option value=en :selected="${ this.client.language == 'en' }">English</option>
          </select>
        </div>
        <div class=row>
          <label>Cultural Country</label>
          <select class=row name=culture>
            <option value=fr :selected="${ this.client.language == 'fr' }">France</option>
            <option value=us :selected="${ this.client.language == 'us' }">United States</option>
          </select>
        </div>
      </fieldset>

      <fieldset>
        <legend>Side Notes</legend>

        <label>Groups (comma separared)</label>
        <input name=tags placeholder="Assigned Groups (insert multiple tag separated with a comma)" value="${ this.client.tags.join(', ') }" list=tags-list>
        <datalist id=tags-list>
          <option value=palm>
          <option value=st-patrick>
          <option value=archive>
        </datalist>

        <label>Notes</label>
        <textarea name=note>${ this.client.note || '' }</textarea>
      </fieldset>

      <footer class=toolbar>
        <button class=primary>Save</button>
        <a href=/ class=button>Cancel</a>
        <div class="secondary">
          <button type=button :if="this.client.id" on:click="this.delete" class="danger">delete</delete>
        </div>

      </footer>
    </form>
  </main>

  <aside class="block" :if="this.client.id">
    <h1><x-icon figure=file-medical-alt></x-icon>Assigned Tests</h1>
    <ul>
      <li :for="assignment in this.assignments">
        <div :if="this.assignment && this.assignment.status === 'pending'">
          <span><x-icon figure=clock color=#F5BA01></x-icon>pending since ${ date(this.assignment.creation_date) }</span>
          <nav class=actions>
            <a href="${ config.testUrl.replace('{key}', this.assignment.key) }" title="Go to the TCI test form" target=_blank>
              <x-icon figure=file-signature></x-icon>
            </a>
            <a :if="this.client.email" href="mailto:${ this.client.email }?subject=A TCI test was assigned to you." title="Send the TCI by email to the Client">
              <x-icon figure=envelope></x-icon>
            </a>
            <x-icon figure=trash on:click="this.removeAssignement" value="${ this.assignment.id }" title="Unassign this test from the Client"></x-icon>
          </nav>
        </div>
        <div :if="this.assignment && this.assignment.status === 'completed'">
          <span><x-icon figure=file-invoice></x-icon>completed on ${ date(this.assignment.completion_date) }</span>
          <nav class=actions>
            <a class=score href="${config.apiUrl}/assignment/${ this.assignment.id }/score/1d" target=_blank title="Download results in 1D">1D</a>
            <a class=score href="${config.apiUrl}/assignment/${ this.assignment.id }/score/2d" target=_blank title="Download results in 2D">2D</a>
            <a class=score href="${config.apiUrl}/assignment/${ this.assignment.id }/score/3d" target=_blank title="Download results in 3D">3D</a>
          </nav>
        </div>
      </li>
    </ul>
    <button class=primary on:click="this.assign"><x-icon figure=file-medical></x-icon>Assign a new test</button>
  </aside>

</div>
</template>

<script>
  const defaults = {
    id: null,
    client: { tags: [], assignments: [] },
    assignments: []
  }
  this.setState(defaults)

  this.connected = async () => {
    if(this.state.id) {
      const response = await api(`/client/${this.state.id}`)
      if(response.data) {
        this.state.client = response.data
        this.state.assignments = this.state.client.assignments.reverse()
      }
    }
    this.render()
  }

  this.assign = async () => {
    const response = await api(`/client/${this.state.id}/assignment`, { method: 'post' })
    if (response.data) this.render({ assignments: response.data.assignments.reverse() })
  }

  // pass component scope to function
  const component = this
  this.removeAssignement = async function (event) {
    if(!confirm('Are your sure you want to remove this assignment?')) return
    const response = await api(`/assignment/${this.getAttribute('value')}`, { method: 'delete' })
    component.render({ assignments: response.data.assignments.reverse() })
  }

  this.submit = async (event) => {
    event.preventDefault()
    const client = this.state.client
    const form = event.currentTarget
    const data = {}
    Array.from(form.elements).filter(e => e.name && e.value).forEach(e => data[e.name] = e.value)
    data.tags = data.tags && data.tags.split(',')
    const response = client.id
                   ? await api(`/client/${client.id}`, { data, method: 'PUT' })
                   : await api(`/client`, { data })
    if(!response.ok) {
      if(response.data.includes('duplicate key error')) return alert("A client exists with similar data. Is it a duplicate?")
      return alert('An error occured and the client could not be saved!')
    }
    page('/')
  }

  this.delete = async () => {
    if(!confirm("Are you sure you want to delete this client and all his data?")) return
    const response = await api(`/client/${ this.state.client.id }`, { method: 'delete' })
    if(!response.ok) return alert("An error occured. This contact could not be deleted!")
    page('/')
  }
</script>

<style>
  @import url('/assets/css/main.css');

  aside ul {
    padding: 0;
    list-style: none;
  }

  aside li {
    display: flex;
    justify-content: space-between;
    padding: .5rem 0;
    border-bottom: 1px solid #eee;
  }

  nav > * {
    display: inline-block;
    font-size: .7rem;
    font-weight: bold;
    width: 1.5rem;
    color: var(--primary-color);
    cursor: pointer;
    text-decoration: none;
    text-align: center;
    padding: .2rem;
    border-radius: .2rem;
    border: 1px solid transparent;
  }
  nav > *:hover {
    border-color: var(--primary-color);
  }

  aside button {
    width: 100%;
    margin-top: 1rem;
  }

  a.score {
  }
</style>
