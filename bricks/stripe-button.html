<template quantity=0>
  <slot on:click="this.showPayment"></slot>
</template>

<script>
  this.setState({
    quantity: 1
  })

  this.connected = () => {
    this.handler = StripeCheckout.configure({
      key: config.stripe_public_key,
      image: '',
      locale: 'auto',
      token: async (token) => {
        const response = await api('/payment', { data: { token, quantity: this.state.quantity }})
        if(!response.ok) notify("The payment could not be processed!", 'error')
        notify("Your purchase was successfully completed!", 'success')
        location.reload()  // TODO: refresh the user instead of hard reloading the page
      }
    })
  }

  this.showPayment = () => {
    const unitPrice = this.state.quantity < config.credit_discount_volume ? config.credit_price : config.credit_discount_price
    this.handler.open({
      name: 'Anthropedia',
      description: `${this.state.quantity} TCI credits`,
      amount: this.state.quantity * 100 * unitPrice
    })
  }
</script>

<style>
  root,
  slot {
    display: block;
    width: 100%;
    height: 100%;
  }
</style>
